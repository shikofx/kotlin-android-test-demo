= Урок 11: Установка и настройка GitLab Runner

GitLab Runner — это приложение-агент, которое выполняет CI/CD-задачи, описанные в файле `.gitlab-ci.yml` вашего проекта. Без Runner'а пайплайны не будут запускаться.

Мы будем использовать GitLab Runner как отдельный Docker-контейнер. Это самый гибкий и рекомендуемый способ, который позволяет:
* Изолировать окружение для сборки.
* Использовать Docker для запуска задач (Docker-in-Docker или Docker-out-of-Docker).
* Не засорять основную систему сервера зависимостями для сборки.

== Предварительные требования

Прежде чем приступить к настройке Runner'а, убедитесь, что на вашем сервере установлен Docker. Мы уже устанавливали его на этапе развертывания GitLab (см. link:02-gitlabci-installation.adoc[Урок 2]).

== Общая логика

. *Регистрация:* Мы временно запустим Docker-образ Runner'а для его регистрации в вашем GitLab-инстансе.
. *Запуск как сервис:* После регистрации мы настроим постоянный запуск Runner'а с помощью `docker-compose`.

== Шаг 1: Создание Runner'а в GitLab и получение токена

В современных версиях GitLab старые "токены регистрации" объявлены устаревшими. Вместо них используется более безопасный метод: сначала вы создаете Runner в интерфейсе, а затем получаете *токен аутентификации* для его регистрации.

. *На сервере* создайте директорию, где будет храниться конфигурация Runner'а:
+
[source,bash]
----
sudo mkdir -p /srv/gitlab-runner
----

. *В веб-интерфейсе GitLab* перейдите в ваш проект, а затем в *Settings -> CI/CD*.

. Разверните секцию *Runners* и нажмите кнопку *Create project runner*.

. На открывшейся странице заполните основные поля:
+
* *Tags:* Введите теги, по которым вы будете выбирать этот Runner в `.gitlab-ci.yml`. Например: `docker, linux`. Теги позволяют направлять определенные задачи на определенные Runner'ы.
* *Run untagged jobs:* Поставьте эту галочку, если хотите, чтобы Runner мог выполнять задачи, у которых теги не указаны. Это удобно для общих задач.
* *Runner description (optional):* Добавьте краткое описание, например, "Docker runner on my server".
* Остальные настройки, такие как `Protected` (для защищенных веток) и `Lock to current projects`, можно оставить по умолчанию для начала.

. Нажмите *Create runner*.

. *Вы на странице с токеном!* GitLab покажет вам *Runner authentication token* (начинается с `glrt-`). Скопируйте его. Здесь же будет указан и URL вашего GitLab.

== Шаг 2: Регистрация Runner'а

Теперь, имея URL и токен, мы можем зарегистрировать наш Runner.

[IMPORTANT]
====
На странице с токеном GitLab предлагает выполнить команду `gitlab-runner register ...`. Он предполагает, что вы установили Runner прямо на сервер. Мы же поступим умнее: выполним эту команду *внутри временного Docker-контейнера*, чтобы не устанавливать ничего лишнего на хост-систему.
====

. Вернитесь в консоль вашего сервера.

. Выполните команду ниже. Она запускает временный контейнер, который выполняет команду `register` со всеми необходимыми параметрами и сохраняет результат в `/srv/gitlab-runner/config`.
+
*Подставьте в нее ваш URL и токен аутентификации*, полученные на предыдущем шаге:
+
[source,bash]
----
sudo docker run --rm -it \
  -v /srv/gitlab-runner/config:/etc/gitlab-runner \
  -v /var/run/docker.sock:/var/run/docker.sock \
  gitlab/gitlab-runner:latest register \
  --non-interactive \
  --url "https://gitlab.your_domain.xyz" \
  --token "ВАШ_ТОКЕН_АУТЕНТИФИКАЦИИ" \
  --executor "docker" \
  --docker-image alpine:latest
----

*Разбор ключевых параметров:*
* `-v /srv/gitlab-runner/config...`: Создает постоянное хранилище для конфигурации Runner'a. После выполнения команды здесь появится файл `config.toml`.
* `-v /var/run/docker.sock...`: *Ключевой момент!* Пробрасывает Docker-сокет хост-машины внутрь контейнера. Это позволит вашему Runner'у запускать другие Docker-контейнеры (например, для сборки Android-приложения). Этот подход называется "Docker-out-of-Docker".
* `--executor "docker"`: Указывает, что каждая задача (job) будет выполняться в новом, чистом Docker-контейнере.
* `--docker-image alpine:latest`: Образ по умолчанию, который будет использоваться для задач, если в `.gitlab-ci.yml` не указан другой.

После выполнения этой команды в директории `/srv/gitlab-runner/config` будет создан файл `config.toml`.

== Шаг 3: Конфигурация Docker-out-of-Docker (DooD)

Это *ключевой шаг* для того, чтобы CI-задачи могли сами выполнять `docker`-команды (например, для сборки образов).

По умолчанию Runner, хоть и имеет доступ к Docker-сокету, не пробрасывает его внутрь контейнеров, в которых выполняются ваши задачи. Нам нужно явно указать ему это делать.

. Откройте для редактирования файл `config.toml`, который был создан на предыдущем шаге:
+
[source,bash]
----
sudo nano /srv/gitlab-runner/config/config.toml
----

. Найдите секцию `[runners.docker]` и добавьте в нее параметр `volumes`. Он указывает, какие тома нужно монтировать в *каждый* контейнер с задачей.
+
[source,toml]
----
# ... (другие параметры runner'а)
  [runners.docker]
    tls_verify = false
    image = "alpine:latest"
    privileged = false
    disable_entrypoint_overwrite = false
    oom_kill_disable = false
    disable_cache = false
    volumes = ["/var/run/docker.sock:/var/run/docker.sock", "/cache"] # <-- ДОБАВИТЬ ЭТУ СТРОКУ
    shm_size = 0
----
+
Теперь каждая задача, запущенная этим Runner'ом, будет иметь доступ к Docker-демону хост-машины.

== Шаг 4: Запуск Runner'а как сервиса

. Создайте файл `/srv/gitlab-runner/docker-compose.yml`:
+
[source,bash]
----
sudo nano /srv/gitlab-runner/docker-compose.yml
----

. Вставьте в него следующее содержимое:
+
[source,yaml]
----
version: '3.6'
services:
  runner:
    image: gitlab/gitlab-runner:latest
    container_name: gitlab-runner
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /srv/gitlab-runner/config:/etc/gitlab-runner
----
+
Обратите внимание, что мы используем те же `volumes`, что и при регистрации, чтобы Runner мог использовать сохраненную конфигурацию.

. Перейдите в директорию и запустите сервис:
+
[source,bash]
----
cd /srv/gitlab-runner
sudo docker compose up -d
----

== Шаг 5: Проверка

Вернитесь в веб-интерфейс GitLab на страницу *Settings -> CI/CD -> Runners*. Вы должны увидеть свой новый Runner в списке с зеленым кружком, что означает, что он активен и готов принимать задачи.

Готово! Теперь ваш GitLab-сервер может автоматически собирать и тестировать проекты.