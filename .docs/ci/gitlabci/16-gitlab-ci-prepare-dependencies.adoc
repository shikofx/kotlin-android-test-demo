= Урок 3: Задача `prepare_dependencies`

Теперь, когда у нас есть стадия `.pre`, давайте добавим в нее задачу `prepare_dependencies`. Ее единственная цель — загрузить все зависимости проекта и сохранить их в кэш для использования в последующих задачах.

== Что делает эта задача?

*   *`stage: .pre`*: Указывает, что задача должна выполняться на самой первой стадии.
*   *`script: - ./gradlew androidDependencies`*: Эта команда заставляет Gradle проанализировать все зависимости проекта и загрузить их, не выполняя сборку или тесты.
*   *`cache: policy: push`*: Это ключевая особенность. Мы переопределяем глобальную политику кэширования.
**   `push` означает, что эта задача будет *только записывать* (выгружать) данные в кэш. Она не будет ничего из него загружать.
**   Это идеальный паттерн для "прогрева" кэша: одна задача отвечает за его создание и обновление, а все остальные — только за чтение.

== Изменения в `.gitlab-ci.yml`

Мы добавляем новую задачу `prepare_dependencies`.

[source,diff]
----
prepare_dependencies:
  stage: .pre
  script:
    - ./gradlew androidDependencies
  cache:
    # На этой стадии мы только создаем/обновляем кэш, но ничего не загружаем
    - key:
        files:
          - build.gradle
      paths:
        - $GRADLE_USER_HOME/caches/modules-2
        - $GRADLE_USER_HOME/caches/jars-9
      policy: push # Только выгружаем обновленные зависимости
    - key: "gradle-build-cache-${CI_COMMIT_REF_SLUG}"
      paths:
        - $GRADLE_USER_HOME/caches/build-cache-8
      policy: push
----