# Урок 11: Установка и настройка GitLab Runner

GitLab Runner — это приложение-агент, которое выполняет CI/CD-задачи, описанные в файле `.gitlab-ci.yml` вашего проекта. Без Runner'а пайплайны не будут запускаться.

Мы будем использовать GitLab Runner как отдельный Docker-контейнер. Это самый гибкий и рекомендуемый способ, который позволяет:
*   Изолировать окружение для сборки.
*   Использовать Docker для запуска задач (Docker-in-Docker или Docker-out-of-Docker).
*   Не засорять основную систему сервера зависимостями для сборки.

## Предварительные требования

Прежде чем приступить к настройке Runner'а, убедитесь, что на вашем сервере установлен Docker. Мы уже устанавливали его на этапе развертывания GitLab (см. Урок 2).

## Общая логика

1.  **Регистрация:** Мы временно запустим Docker-образ Runner'а для его регистрации в вашем GitLab-инстансе.
2.  **Запуск как сервис:** После регистрации мы настроим постоянный запуск Runner'а с помощью `docker-compose`.

## Шаг 1: Создание Runner'а в GitLab и получение токена

В современных версиях GitLab старые "токены регистрации" объявлены устаревшими. Вместо них используется более безопасный метод: сначала вы создаете Runner в интерфейсе, а затем получаете **токен аутентификации** для его регистрации.

1.  **На сервере** создайте директорию, где будет храниться конфигурация Runner'а:
    ```bash
    sudo mkdir -p /srv/gitlab-runner
    ```

2.  **В веб-интерфейсе GitLab** перейдите в ваш проект, а затем в **Settings -> CI/CD**.

3.  Разверните секцию **Runners** и нажмите кнопку **Create project runner**.

4.  На открывшейся странице заполните основные поля:
    *   **Tags:** Введите теги, по которым вы будете выбирать этот Runner в `.gitlab-ci.yml`. Например: `docker, linux`. Теги позволяют направлять определенные задачи на определенные Runner'ы.
    *   **Run untagged jobs:** Поставьте эту галочку, если хотите, чтобы Runner мог выполнять задачи, у которых теги не указаны. Это удобно для общих задач.
    *   **Runner description (optional):** Добавьте краткое описание, например, "Docker runner on my server".
    *   Остальные настройки, такие как `Protected` (для защищенных веток) и `Lock to current projects`, можно оставить по умолчанию для начала.

5.  Нажмите **Create runner**.

6.  **Вы на странице с токеном!** GitLab покажет вам **Runner authentication token** (начинается с `glrt-`). Скопируйте его. Здесь же будет указан и URL вашего GitLab.

## Шаг 2: Регистрация Runner'а

Теперь, имея URL и токен, мы можем зарегистрировать наш Runner.

> **Важно:** На странице с токеном GitLab предлагает выполнить команду `gitlab-runner register ...`. Он предполагает, что вы установили Runner прямо на сервер. Мы же поступим умнее: выполним эту команду **внутри временного Docker-контейнера**, чтобы не устанавливать ничего лишнего на хост-систему.

1.  Вернитесь в консоль вашего сервера.

2.  Выполните команду ниже. Она запускает временный контейнер, который выполняет команду `register` со всеми необходимыми параметрами и сохраняет результат в `/srv/gitlab-runner/config`.

    **Подставьте в нее ваш URL и токен аутентификации**, полученные на предыдущем шаге:

    ```bash
    sudo docker run --rm -it \
      -v /srv/gitlab-runner/config:/etc/gitlab-runner \
      -v /var/run/docker.sock:/var/run/docker.sock \
      gitlab/gitlab-runner:latest register \
      --non-interactive \
      --url "https://gitlab.your_domain.xyz" \
      --token "ВАШ_ТОКЕН_АУТЕНТИФИКАЦИИ" \
      --executor "docker" \
      --docker-image alpine:latest
    ```
    
**Разбор ключевых параметров:**
*   `-v /srv/gitlab-runner/config...`: Создает постоянное хранилище для конфигурации Runner'a. После выполнения команды здесь появится файл `config.toml`.
*   `-v /var/run/docker.sock...`: **Ключевой момент!** Пробрасывает Docker-сокет хост-машины внутрь контейнера. Это позволит вашему Runner'у запускать другие Docker-контейнеры (например, для сборки Android-приложения). Этот подход называется "Docker-out-of-Docker".
*   `--executor "docker"`: Указывает, что каждая задача (job) будет выполняться в новом, чистом Docker-контейнере.
*   `--docker-image alpine:latest`: Образ по умолчанию, который будет использоваться для задач, если в `.gitlab-ci.yml` не указан другой.

## Шаг 3: Запуск Runner'а как сервиса

Регистрация была разовой акцией. Теперь запустим Runner как постоянно работающий сервис с помощью `docker-compose`.

1.  Создайте файл `/srv/gitlab-runner/docker-compose.yml`:
    ```bash
    sudo nano /srv/gitlab-runner/docker-compose.yml
    ```

2.  Вставьте в него следующее содержимое:
    ```yaml
    version: '3.6'
    services:
      runner:
        image: gitlab/gitlab-runner:latest
        container_name: gitlab-runner
        restart: always
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - /srv/gitlab-runner/config:/etc/gitlab-runner
    ```
    Обратите внимание, что мы используем те же `volumes`, что и при регистрации, чтобы Runner мог использовать сохраненную конфигурацию.

3.  Перейдите в директорию и запустите сервис:
    ```bash
    cd /srv/gitlab-runner
    sudo docker compose up -d
    ```

## Шаг 4: Проверка

Вернитесь в веб-интерфейс GitLab на страницу **Settings -> CI/CD -> Runners**. Вы должны увидеть свой новый Runner в списке с зеленым кружком, что означает, что он активен и готов принимать задачи.

Готово! Теперь ваш GitLab-сервер может автоматически собирать и тестировать проекты.