= Настройка HTTPS с помощью Certbot

Теперь, когда Nginx настроен для обработки HTTP-трафика для наших доменов, последний шаг — защитить их с помощью HTTPS. Мы сделаем это с помощью `certbot` и его плагина для Nginx.

== Шаг 1: Запуск Certbot

Выполните одну команду, указав все домены, для которых вы хотите получить сертификаты.

[source,bash]
----
sudo certbot --nginx --redirect -d gitlab.<ваш-домен>.xyz -d s3.<ваш-домен>.xyz
----

[TIP]
====
*   `--nginx`: Указывает `certbot` использовать плагин для Nginx. Он автоматически найдет ваши конфигурационные файлы и изменит их.
*   `--redirect`: Явно указывает `certbot` настроить автоматическое перенаправление всех HTTP-запросов на HTTPS.
*   `-d ...`: Указывает домен, для которого нужен сертификат. Можно указать несколько.
====

`certbot` задаст несколько вопросов (например, ваш email для уведомлений и согласие с условиями). После их ответа он:
. Свяжется с серверами Let's Encrypt для подтверждения владения доменами.
. Получит SSL-сертификаты.
. Автоматически изменит ваши конфигурационные файлы Nginx (в `/etc/nginx/sites-enabled/`), добавив в них пути к сертификатам и настройки для HTTPS.

== Шаг 2: Настройка брандмауэра

Certbot настраивает Nginx, но не управляет брандмауэром. Чтобы разрешить входящий HTTPS-трафик, вам нужно вручную открыть порт `443`.

[source,bash]
----
sudo ufw allow https
sudo ufw reload
----

== Решение проблемы "Permission Denied"

После запуска `certbot` вы можете столкнуться с ошибкой при проверке конфигурации (`sudo nginx -t`):

[source,text]
----
nginx: [emerg] cannot load certificate ".../fullchain.pem": ... Permission denied
----

Это происходит потому, что Nginx (а точнее, его рабочие процессы, запущенные от пользователя `www-data`) не имеет прав на чтение директории `/etc/letsencrypt/`, где хранятся сертификаты.

**Решение:** Добавить пользователя `www-data` в группу `root`, чтобы он мог читать эти файлы.

. Добавьте пользователя в группу:
+
[source,bash]
----
sudo usermod -aG root www-data
----

. Перезапустите Nginx, чтобы применить новые права:
+
[source,bash]
----
sudo systemctl restart nginx.service
----
+
[TIP]
====
После перезапуска проверьте статус еще раз: `sudo systemctl status nginx.service`.
+
Теперь вы должны увидеть зеленую надпись `active (running)`, что подтверждает успешный запуск. Нажмите `q`, чтобы выйти из просмотра статуса.
+
====

== Шаг 3: Автоматическое обновление

Пакет `certbot`, который мы установили, автоматически настраивает системный таймер (`systemd timer` или `cron job`), который будет дважды в день пытаться обновить сертификаты. Обновление произойдет только в том случае, если до истечения срока действия сертификата осталось менее 30 дней.

Вам не нужно ничего делать вручную. Проверить статус таймера можно командой: `sudo systemctl list-timers | grep certbot`.