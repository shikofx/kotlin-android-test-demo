= Урок 3: Конфигурация сайтов (Server Blocks) в Nginx

После установки Nginx нам нужно объяснить ему, как обрабатывать запросы к нашим доменам (`gitlab.<...>` и `s3.<...>`). Это делается с помощью конфигурационных файлов, которые в терминологии Nginx называются "серверными блоками" (server blocks).

== Структура конфигурации

Nginx хранит конфигурации сайтов в двух директориях:
*   `/etc/nginx/sites-available/`: Здесь лежат файлы с конфигурациями для *всех* сайтов, которые может обслуживать сервер.
*   `/etc/nginx/sites-enabled/`: Здесь лежат *символические ссылки* на файлы из `sites-available`. Nginx читает конфигурации только из этой директории.

Такая структура позволяет легко "включать" и "выключать" сайты, просто создавая или удаляя символические ссылки.

== Шаг 1: Создание конфигурации для GitLab

. Создайте новый файл для домена GitLab:
+
[source,bash]
----
sudo nano /etc/nginx/sites-available/gitlab.<ваш-домен>.xyz
----

. Вставьте базовую конфигурацию, которая перенаправляет трафик на внутренний порт GitLab (`8081`):
+
[source,nginx]
----
server {
    listen 80;
    server_name gitlab.<ваш-домен>.xyz;

    location / {
        proxy_pass http://localhost:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
----

== Шаг 2: Создание конфигурации для MinIO

. Аналогично создайте файл для домена MinIO:
+
[source,bash]
----
sudo nano /etc/nginx/sites-available/s3.<ваш-домен>.xyz
----

. Вставьте конфигурацию, которая перенаправляет трафик на внутренний порт MinIO (`9002`) и добавляет специальные заголовки, необходимые для S3-хранилищ.
+
[source,nginx]
----
server {
    listen 80;
    server_name s3.<ваш-домен>.xyz;

    location / {
        proxy_pass http://localhost:9002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Amz-Content-Sha256 $http_x_amz_content_sha256;
    }
}
----

== Шаг 3: Активация сайтов и проверка

. Создайте символические ссылки, чтобы "включить" оба сайта:
+
[source,bash]
----
sudo ln -s /etc/nginx/sites-available/gitlab.<ваш-домен>.xyz /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/s3.<ваш-домен>.xyz /etc/nginx/sites-enabled/
----

. Проверьте синтаксис конфигурации Nginx. Это **обязательный** шаг перед перезапуском.
+
[source,bash]
----
sudo nginx -t
----
+
Если вы видите `syntax is ok` и `test is successful`, значит все в порядке.

. Перезапустите Nginx, чтобы применить изменения:
+
[source,bash]
----
sudo systemctl restart nginx.service
----