= Управление артефактами и кэшем

**Цель:** Эффективно управлять данными, которые генерируются и используются в CI/CD пайплайне, чтобы экономить место в хранилище GitHub и поддерживать порядок.

== 1. Управление временем хранения артефактов

По умолчанию GitHub хранит артефакты сборок (APK, отчеты) в течение 90 дней. В нашем проекте это время сокращено до 2 дней, чтобы не накапливать устаревшие данные.

=== 1.1. Настройка `retention-days`

Это достигается с помощью параметра `retention-days` в экшене `actions/upload-artifact`.

[source,yaml]
----
- name: Upload analysis reports
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: static-analysis-reports
    path: app/build/reports/
    retention-days: 2
----

*   `retention-days: 2`: Указывает GitHub Actions автоматически удалить этот артефакт через 2 дня после его создания.

Эта настройка применена ко всем шагам, которые загружают артефакты в `.github/workflows/android-ci.yml`.

== 2. Агрессивная очистка кэша Gradle

GitHub Actions автоматически удаляет кэши, которые не использовались более 7 дней. Однако, чтобы иметь более строгий контроль и гарантированно не выходить за пределы лимитов хранилища (10 ГБ для бесплатных аккаунтов), в пайплайн добавлен шаг для агрессивной очистки старых кэшей Gradle.

=== 2.1. Логика работы скрипта

В конце задачи `build_and_analyze` выполняется специальный шаг `Clean up gradle caches`.

[source,yaml]
----
- name: Clean up gradle caches
  if: always()
  uses: actions/github-script@v7
  with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    script: |
      # ... (JavaScript-код для очистки)
----

Этот скрипт, используя `actions/github-script`, выполняет следующие действия:
. **Получает список всех кэшей** в репозитории через GitHub API.
. **Фильтрует** их, оставляя только те, что относятся к Gradle (с префиксом `linux-gradle-`).
. **Сортирует** найденные кэши по дате создания, от новых к старым.
. **Удаляет все кэши, кроме одного самого нового.**

Таким образом, после каждой успешной сборки в репозитории остается только самый актуальный кэш Gradle.

=== 2.2. Необходимые права

Для того чтобы скрипт мог удалять кэши, воркфлоу должны быть предоставлены соответствующие права. Это делается добавлением `actions: write` в блок `permissions`.

[source,yaml]
----
permissions:
  actions: write
  contents: read
  # ... другие права
----