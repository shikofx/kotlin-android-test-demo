= Публикация отчетов на GitHub Pages

**Цель:** Сделать все HTML-отчеты (PMD, Checkstyle, Lint) и список известных проблем (Lint Baseline) легкодоступными для просмотра в браузере по единой ссылке без необходимости скачивать артефакты.

== 1. Настройка репозитория (разовая)

Чтобы GitHub Actions мог публиковать страницы, необходимо выполнить две настройки в репозитории.

. Перейдите в `Settings` -> `Pages`.
. В разделе `Build and deployment` в выпадающем списке `Source` выберите **GitHub Actions**.

== 2. Настройка CI/CD пайплайна

В файле `.github/workflows/android-ci.yml` реализована следующая логика:

=== 2.1. Предоставление прав

В воркфлоу добавлены специальные права, разрешающие чтение контента, запись на GitHub Pages и получение `id-token` для аутентификации.

[source,yaml]
----
permissions:
  contents: read
  pages: write
  id-token: write
----

=== 2.2. Подготовка и структурирование отчетов

Ключевой шаг в пайплайне — это `Structure reports for GitHub Pages`. Он выполняется всегда (`if: always()`), даже если предыдущие шаги (анализ, тесты) завершились с ошибкой, чтобы отчеты были доступны для анализа в любом случае.

[source,yaml]
----
- name: Structure reports for GitHub Pages
  if: always()
  run: |
    # ... (содержимое скрипта)
----
Этот shell-скрипт выполняет следующие ключевые задачи:

. **Инициализация и создание главной страницы.**
+
*   `mkdir -p pages_root`: Создается корневая директория `pages_root` для будущего сайта.
*   `cat <<EOF > pages_root/index.html`: С помощью `heredoc` генерируется `index.html` — главная страница со ссылками на все отчеты. В нее сразу встраиваются CSS-стили для аккуратного отображения, похожего на интерфейс GitHub.

+
. **Универсальная обработка отчетов (PMD, Checkstyle).**
+
*   Скрипт использует цикл `for tool in pmd checkstyle; do ... done`, чтобы избежать дублирования кода.
*   Для каждого инструмента проверяется наличие директории с отчетами (например, `app/build/reports/pmd`).
*   `cp -r "${report_dir}" "pages_root/"`: Если директория найдена, она полностью копируется. Это важно, так как отчеты часто содержат собственные файлы стилей (CSS) и скрипты (JS).
*   Внутренний цикл находит все `.html` файлы в скопированной директории и динамически создает для них ссылки, добавляя их в `index.html`. Названия ссылок форматируются для лучшей читаемости (например, "Pmd Report (Debug)").

. **Обработка отчета Android Lint.**
+
*   Этот отчет обрабатывается отдельно, так как Lint генерирует один файл с фиксированным именем `lint-results-debug.html`.
*   Скрипт проверяет его наличие, создает для него отдельную папку `pages_root/lint` и копирует отчет, переименовывая его в `debug.html` для единообразия.
*   Ссылка на отчет также добавляется на главную страницу.

. **Визуализация Lint Baseline.**
+
*   Это самая нетривиальная часть. Файл `app/lint-baseline.xml` — это просто XML со списком известных проблем, и для него нет стандартного HTML-отчета.
*   Скрипт проверяет наличие `app/lint-baseline.xml`.
*   Если файл найден, для него создается отдельная HTML-страница `pages_root/lint-baseline/index.html`.
*   `sed ...`: Ключевая команда. Она считывает XML-файл и с помощью утилиты `sed` выполняет две задачи:
**  Экранирует основные HTML-символы (`<`, `>`, `&`), чтобы они не ломали разметку страницы.
**  Декодирует XML-сущности для кавычек (`&apos;` и `&quot;`), заменяя их на обычные символы `'` и `"` для лучшей читаемости.
*   Обработанный результат вставляется внутрь тегов `<pre><code>` на сгенерированной странице, что позволяет корректно отобразить XML-код в браузере.
*   На страницу также добавляется ссылка "Назад" для удобной навигации.
*   На главную страницу `index.html` добавляется ссылка "Lint Baseline (Known Issues)".

. **Завершение.**
+
В конец `index.html` добавляются закрывающие теги `</ul>`, `</body>`, `</html>`.

=== 2.3. Загрузка артефакта для Pages

Подготовленная директория `pages_root` загружается как специальный артефакт, который будет использоваться для развертывания.

[source,yaml]
----
- name: Upload Pages artifact
  if: always()
  uses: actions/upload-pages-artifact@v4
  with:
    path: pages_root
----

=== 2.4. Развертывание (Deploy)

Отдельная задача `report` запускается после основной сборки (`build_and_analyze`) и публикует подготовленный артефакт на GitHub Pages.

[source,yaml]
----
report:
  name: Report
  needs: build_and_analyze
  environment:
    name: github-pages
    url: ${{ steps.deployment.outputs.page_url }}
  runs-on: ubuntu-latest
  steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
----

После успешного выполнения пайплайна ссылка на опубликованный отчет будет доступна в разделе `Environments` на главной странице репозитория.
image::../../.docs/img/github-pages-reports.png[Скриншот страницы с отчетами]