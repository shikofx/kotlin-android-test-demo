= Урок 3: Кэширование зависимостей и подготовка Gradle

**Цель:** Значительно ускорить будущие сборки с помощью кэширования зависимостей Gradle и подготовить Gradle Wrapper к работе.

== Ключевые концепции

* *Gradle Wrapper (`gradlew`)*: Рекомендуемый способ запуска Gradle-задач. Он гарантирует, что все разработчики и CI-серверы используют одну и ту же версию Gradle, что исключает проблемы совместимости.
* *`chmod +x`*: Команда в Unix-подобных системах (включая Linux), которая добавляет файлу право на исполнение.
* *`actions/cache`*: Официальное действие (action) от GitHub для кэширования файлов между запусками пайплайна. Это один из самых эффективных способов ускорения CI/CD.
* *Ключ кэша (`key`)*: Уникальный идентификатор, который позволяет `actions/cache` находить и восстанавливать нужный кэш.
* *`hashFiles`*: Функция в GitHub Actions, которая вычисляет хеш-сумму содержимого указанных файлов. Используется для автоматического обновления кэша при изменении зависимостей.

---

== Шаг 1: Обновление файла Workflow

Добавим два подготовительных шага: кэширование и выдачу прав на исполнение `gradlew`.

[source,yaml,subs="callouts"]
----
name: Android CI

on:
  push:
    branches: 
        - '**' 
  pull_request:
    branches: 
        - main

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages <1>
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew <2>
        run: chmod +x gradlew
----
<1> Добавляем шаг для кэширования зависимостей Gradle.
<2> Даем скрипту `gradlew` права на исполнение, чтобы его можно было запускать в следующих шагах.

=== Детальный разбор шагов

==== 1. `Cache Gradle packages`

Этот шаг — одна из самых важных оптимизаций для любого CI-пайплайна. Без кэширования каждая сборка будет скачивать все зависимости (библиотеки) вашего проекта из интернета заново. Это медленно и неэффективно.

* *`uses: actions/cache@v4`*: Используем официальное действие для кэширования.

* *`with:`*: Передаем параметры в action.
** *`path`*: Указывает, какие директории нужно сохранить в кэш.
*** `~/.gradle/caches`: Здесь Gradle хранит скачанные библиотеки, плагины и другие артефакты. Это основная цель кэширования.
*** `~/.gradle/wrapper`: Здесь хранятся файлы самого Gradle Wrapper. Их кэширование тоже немного ускоряет процесс.
** *`key`*: Это уникальный ключ для идентификации кэша.
*** `key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}`
*** *`{{ runner.os }}`*: Тип операционной системы (например, `Linux`). Это гарантирует, что кэш, созданный на Linux, не будет использоваться на Windows.
*** *`gradle-`*: Просто префикс для понимания, что этот кэш хранит библиотеки, скачанные Gradle.
*** *`{{ hashFiles(...) }}`*: **Самая важная часть.** Эта функция вычисляет хеш-сумму всех файлов, соответствующих шаблонам (`**/*.gradle*`, `**/gradle-wrapper.properties`).
*** *Как это работает?* Если вы измените версию библиотеки в `build.gradle`, хеш-сумма изменится, и `key` станет другим. GitHub Actions не найдет кэш с таким ключом и создаст новый. Если же файлы не менялись, ключ останется прежним, и будет использован существующий кэш. Это идеальный механизм для автоматической инвалидации кэша.
** *`restore-keys`*: Ключи для частичного восстановления.
*** `restore-keys: | ${{ runner.os }}-gradle-`
*** Если точное совпадение по `key` не найдено (например, вы добавили новую библиотеку), GitHub Actions попытается найти кэш, ключ которого начинается с `Linux-gradle-`. Это может восстановить большую часть старых зависимостей, и Gradle докачает только недостающие, что все равно быстрее, чем скачивать все с нуля.

==== 2. `Grant execute permission for gradlew`

* *`run: chmod +x gradlew`*: Эта команда добавляет файлу `gradlew` право на исполнение (`eXecute`).
* *Зачем это нужно?* Когда вы клонируете репозиторий из Git, права на исполнение файлов не всегда сохраняются. Без этого шага попытка запустить `./gradlew` в будущем привела бы к ошибке "Permission denied".

== Шаг 2: Что делает новый пайплайн?

. Запускается на `push` или `pull_request`.
. Клонирует репозиторий.
. Устанавливает Java Development Kit (JDK) версии 17.
. **(Новое)** Восстанавливает кэш Gradle из предыдущих сборок или создает новый, если зависимости изменились.
. **(Новое)** Дает файлу `gradlew` права на запуск.

После коммита этих изменений перейдите на вкладку **Actions**. При первом запуске вы увидите, что шаг кэширования занимает некоторое время на сохранение кэша. При последующих запусках (если вы не меняли gradle-файлы) вы увидите, что кэш восстанавливается очень быстро, что и является нашей целью.