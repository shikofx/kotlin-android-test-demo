= Публикация отчетов на GitHub Pages

**Цель:** Сделать HTML-отчеты (например, от PMD) легкодоступными для просмотра в браузере без необходимости скачивать и распаковывать артефакты сборки.

== 1. Настройка репозитория (разовая)

Чтобы GitHub Actions мог публиковать страницы, необходимо выполнить две настройки в репозитории.

=== 1.1. Включение GitHub Actions как источника

. Перейдите в `Settings` -> `Pages`.
. В разделе `Build and deployment` в выпадающем списке `Source` выберите **GitHub Actions**.

=== 1.2. Настройка правил развертывания

По умолчанию GitHub разрешает публикацию только из основной ветки. Чтобы отчеты публиковались из любой ветки (включая feature-ветки), нужно изменить это правило.

. Перейдите в `Settings` -> `Environments`.
. Нажмите на среду `github-pages`.
. В разделе `Deployment branches` выберите опцию **All branches**.
. Нажмите `Save protection rules`.

== 2. Настройка CI/CD пайплайна

В файле `.github/workflows/android-ci.yml` реализована следующая логика:

=== 2.1. Предоставление прав

В воркфлоу добавлены специальные права, разрешающие публикацию на GitHub Pages.

[source,yaml]
----
permissions:
  pages: write
  id-token: write
----

=== 2.2. Подготовка артефактов для отладки CI
. **Загрузка директории сборки для отладки:**
+
Чтобы иметь возможность анализировать корректность структуры проекта и отлаживать пайплайн, мы загружаем все содержимое директории `app/build` как отдельный артефакт. Это позволяет скачать полный результат работы Gradle и изучить его локально.
+
[source,yaml]
----
- name: Upload full build directory for inspection
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: full-build-output
    path: app/build/
----

=== 2.3. Подготовка отчета

После запуска анализаторов выполняется специальный шаг, который готовит файлы для публикации.

[source,yaml]
----
- name: Structure reports for GitHub Pages
  if: always()
  run: |
    # ... (скрипт)
----
Этот скрипт выполняет следующие действия:

. Создает корневую директорию `pages_root` для будущего сайта.
. Последовательно ищет HTML-отчет PMD (`debug.html`, а затем `release.html`) в директории `app/build/reports/pmd/`.
. Если отчет найден, копирует все его содержимое (включая CSS и JS) в `pages_root/pmd/` и создает корневой `index.html`, который автоматически перенаправляет пользователя на найденный отчет.
. Если отчет не найден, создает `index.html` с сообщением об отсутствии отчета, чтобы избежать ошибки 404.

=== 2.4. Загрузка артефакта для Pages

Подготовленная папка загружается как специальный артефакт, который будет использоваться для развертывания.

[source,yaml]
----
- name: Upload Pages artifact
  if: always()
  uses: actions/upload-pages-artifact@v4
  with:
    path: 'pages_root'
----

=== 2.5. Развертывание (Deploy)

Отдельная задача `report` запускается после основной сборки и публикует подготовленный артефакт.

[source,yaml]
----
report:
  name: Report
  needs: build_and_analyze
  # ...
  steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
----

После успешного выполнения пайплайна ссылка на опубликованный отчет будет доступна в разделе `Environments` на главной странице репозитория.