# Детальный План Работы над проектом "kotlin-android-test-demo"

Этот документ является детализацией общего стратегического плана и описывает конкретные задачи для проекта `kotlin-android-test-demo`. Цель проекта — создать исчерпывающее портфолио, демонстрирующее эволюцию подходов к UI-тестированию в Android.

## Структура веток

Проект развивается поэтапно, следуя GitFlow-подобной стратегии. Каждый этап представлен в отдельной feature-ветке.

| Ветка | Описание | Ключевые технологии |
| :--- | :--- | :--- |
| `feature/*` | Ветки для разработки нового функционала (например, `feature/1-infrastructure-setup`). Создаются из `develop`. | - |
| `develop` | **Ветка для интеграции:** Основная ветка разработки, куда сливаются `feature`-ветки. | - |
| `main` | **Релизная ветка:** Содержит стабильный код, готовый к публикации. Слияние в `main` инициирует релизный процесс. | - |
| `feature/1-infrastructure-setup` | **Подготовка инфраструктуры:** Настройка CI/CD и статического анализа Java-кода. | `GitHub Actions`, `GitLab CI`, `Docker`, `Checkstyle`, `PMD` |
| `feature/2-unit-tests` | **Модульное тестирование:** Написание Unit-тестов для бизнес-логики и интеграция с **Allure Report**. | `JUnit5`, `Allure Report` |
| `feature/3-logic-refactoring` | **Рефакторинг бизнес-логики:** Исправление проблем, найденных статическим анализом, под защитой Unit-тестов. | `Java`, `Checkstyle`, `PMD` |
| `feature/4-integration-tests` | **Интеграционное тестирование:** Написание тестов для проверки взаимодействия компонентов (например, слой БД). | `JUnit5`, `Room` |
| `feature/5-integration-refactoring` | **Рефакторинг слоя данных:** Исправление кода, связанного с базой данных, под защитой интеграционных тестов. | `Java`, `Room` |
| `feature/6-espresso-initial` | **Базовый уровень UI-тестов:** Реализация первых UI-тестов с использованием **Espresso**. | `Espresso`, `JUnit4` |
| `feature/7-ui-refactoring` | **Рефакторинг UI-слоя:** Исправление кода UI-компонентов под защитой Espresso-тестов. | `Java`, `Espresso` |
| `feature/8-kakao` | **Улучшение читаемости:** Тесты переписаны с использованием DSL-обертки **Kakao**, внедрен паттерн Page Object. | `Kakao`, `Page Object` |
| `feature/9-kaspresso` | **Стабильность и мощь:** Тесты мигрированы на фреймворк **Kaspresso** для повышения стабильности и работы со сложными сценариями. | `Kaspresso`, `BrowserStack` |
| `feature/10-kotlin-conversion` | **Рефакторинг:** Проведен масштабный рефакторинг исходного кода приложения под защитой Kaspresso-тестов. | `Kotlin`, `ViewBinding`, `Gradle KTS` |

---

## Этап 1: Настройка инфраструктуры и CI/CD (11.09 - 25.09)

**Цель:** Создать надежный фундамент для разработки и тестирования. Настроить базовый CI/CD пайплайн и интегрировать статический анализ для **Java-кода**.

* [x] **Ветка:** `feature/1-infrastructure-setup`
* [x] **Задачи по коду:**
  * [x] Разработать тест-план (`TESTING_STRATEGY.md`).
* [x] **Задачи по CI/CD (GitHub Actions):**
  * [x] Создать workflow `.github/workflows/ci.yml` с базовой логикой запуска (`push`).
  * [x] Настроить сборку debug APK.
  * [x] Интегрировать статические анализаторы: **Checkstyle**, **PMD**, **Android Lint**.
  * [x] Настроить публикацию отчетов на **GitHub Pages**.
  * [x] Оптимизировать пайплайн: распараллелить задачи, настроить кэширование и очистку кэша.
  * [x] Настроить ручной запуск (`workflow_dispatch`) и управление временем хранения артефактов.
* [ ] **Задачи по CI/CD (GitLab CI):**
  * **Развертывание GitLab:**
    * [x] **Сервер и домен:** Зарегистрировано доменное имя, настроена A-запись, арендован сервер.
    * [x] **Установка GitLab:** Установлен GitLab (CE) с помощью Docker, выполнен первый вход.
    * [x] **Настройка HTTPS:** Включен встроенный Let's Encrypt для автоматического получения SSL-сертификатов.
    * [x] **Репозиторий:** Настроен локальный репозиторий для одновременной работы с GitHub и GitLab (`multi-remote`).
    * [x] **Проект:** Созданы пользователи и проект в GitLab.
    * [x] **(Отложено)** Настройка связки с внешним Nginx и MinIO будет выполнена на более поздних этапах.
  * **Подготовка образа:**
    * [x] Создан `Dockerfile` для сборки Android-проекта (JDK 17, Android SDK).
    * [x] Настроен `Container Registry` в GitLab для хранения Docker-образа.
    * [x] Собран и опубликован в Registry базовый образ `android-builder:latest`.
  * **Настройка Runner'а:**
    * [x] Установлен и зарегистрирован GitLab Runner на сервере.
    * [x] Runner настроен для использования `docker-executor` с доступом к Docker хоста (DooD).
  * **Настройка `.gitlab-ci.yml`:**
    * [x] Создан базовый `.gitlab-ci.yml` для проверки работоспособности связки GitLab + Runner.
    * [x] Определить `stages` (например, `analyze`, `test`, `build`, `report`).
    * [x] Настроить кэширование зависимостей Gradle с помощью `cache` keyword.
  * **Интеграция статического анализа (параллельно):**
    * [x] Создать job `checkstyle` в `analyze` stage, которая запускает `./gradlew app:checkstyleDebug` и сохраняет отчет как артефакт (`artifacts:paths`).
    * [x] Создать job `pmd` в `analyze` stage, которая запускает `./gradlew app:pmdDebug` и сохраняет отчет.
    * [x] Создать job `lint` в `analyze` stage, которая запускает `./gradlew app:lintDebug` и сохраняет отчет.
  * **Интеграция тестов:**
    * [x] Создать job `unit-test` в `test` stage, которая зависит от `analyze` stage (`needs`) и запускает `./gradlew testDebugUnitTest`.
  * **Сборка приложения:**
    * [x] Создать job `build` в `build` stage, которая зависит от `test` stage.
    * [x] Настроить `rules` для сборки `debug` или `release` APK в зависимости от ветки (`CI_COMMIT_BRANCH`).
  * **Публикация отчетов (GitLab Pages):**
    * [x] Создать специальную job `pages` в `report` stage.
    * [x] Настроить `needs` для загрузки артефактов (отчетов) из всех предыдущих `jobs`.
    * [x] Адаптировать скрипт для генерации `index.html` и копирования отчетов в директорию `public`.
    * [x] Настроить `artifacts:paths` для публикации директории `public` на GitLab Pages.
* [x] **Финализация:**
  * [x] Выполнить слияние ветки `feature/1-infrastructure-setup` в `develop`.

## Этап 2: Модульное тестирование и отчетность (01.10 - 07.10)

**Цель:** Написать первые модульные тесты, покрыть бизнес-логику и интегрировать **Allure Report** для визуализации результатов.

* [x] **Ветка:** `feature/2-unit-tests` (создается из `develop`)
* [x] **Задачи по коду:**
  * [x] Написать Unit-тесты для ключевой бизнес-логики (`Methods`, `ColorModelConverters`, `ProductCatalogViewModel`), используя **JUnit 5**.
* [x] **Задачи по CI/CD (GitHub Actions & GitLab CI):**
  * [x] **Интеграция с Allure Report:**
    * [x] Добавлен плагин Allure в Gradle и настроена публикация отчетов.
* [x] **Задачи по коду (продолжение):**
  * [x] Расширено покрытие Unit-тестами для всех ViewModel (`ProductCatalogViewModel`, `SplashViewModel`, `ProductDetailViewModel`), используя **Mockito** и **Truth**.
  * [x] Проведен рефакторинг ViewModel для внедрения зависимостей (Dependency Injection).
* [x] **Финализация:**
  * [x] Ветка `feature/2-unit-tests` готова к слиянию в `develop`.

## Этап 3: Рефакторинг бизнес-логики (07.10)

**Цель:** Исправить проблемы в Java-коде, обнаруженные статическими анализаторами (Checkstyle, PMD). Рефакторинг проводится безопасно, так как код покрыт Unit-тестами.

* [x] **Ветка:** `feature/3-logic-refactoring` (создается из `develop`)
* [x] **Задачи по коду:**
  * [x] Проанализированы отчеты статического анализа.
  * [x] Проведен итеративный рефакторинг классов, покрытых тестами (`ViewModels`, `Methods`).
  * [x] Устранены проблемы с инкапсуляцией, "магическими числами", производительностью и потенциальными `NPE`.
  * [x] Все Unit-тесты успешно пройдены после рефакторинга.
* [x] **Задачи по CI/CD:**
  * [x] Пайплайн успешно проходит проверки статического анализа (Checkstyle, PMD) после рефакторинга.
* [x] **Финализация:**
  * [x] Ветка `feature/3-logic-refactoring` готова к слиянию в `develop`.

## Этап 4: Интеграционное тестирование (08.10 - 11.10)

**Цель:** Проверить корректность взаимодействия между компонентами, в первую очередь — работу с базой данных (Room).

* [ ] **Ветка:** `feature/4-integration-tests` (создается из `develop`)
* [ ] **Задачи по коду:**
  * [ ] Написать интеграционные тесты для `AppDao` с использованием in-memory базы данных на **JUnit 5**.
  * [ ] Проверить операции вставки, чтения, удаления и сортировки.
* [ ] **Задачи по CI/CD:**
  * [ ] Добавить в пайплайн job для запуска интеграционных тестов.
  * [ ] Убедиться, что результаты интеграционных тестов также попадают в Allure Report.
  * [ ] Настроить запуск интеграционных тестов при создании **`pull_request` в `develop`**.
* [ ] **Финализация:**
  * [ ] Выполнить слияние ветки `feature/4-integration-tests` в `develop`.

## Этап 5: Рефакторинг слоя данных (12.10 - 14.10)

**Цель:** Улучшить код, связанный с базой данных и репозиториями, под защитой написанных интеграционных тестов.

* [ ] **Ветка:** `feature/5-integration-refactoring` (создается из `develop`)
* [ ] **Задачи по коду:**
  * [ ] Провести рефакторинг `AppDao`, `AppDatabase`, `DatabaseRepository`.
  * [ ] Убедиться, что все интеграционные тесты проходят после рефакторинга.
* [ ] **Финализация:**
  * [ ] Выполнить слияние ветки `feature/5-integration-refactoring` в `develop`.

## Этап 6: UI-тестирование (Espresso) (15.10 - 18.10)

**Цель:** Написать первые UI-тесты и интегрировать их результаты в существующую CI/CD и Allure-инфраструктуру.

* [ ] **Ветка:** `feature/6-espresso-initial` (создается из `develop`)
* [ ] **Задачи по коду:**
  * [ ] Написать UI-тесты на Espresso (на **JUnit 4**) для сценариев "Логин" и "Просмотр каталога".
* [ ] **Задачи по CI/CD (GitHub Actions):**
  * [ ] Настроить job `ui-test`, который зависит от `build`:
    * [ ] Использовать `reactivecircus/android-emulator-runner` для запуска эмулятора.
    * [ ] Запустить `./gradlew connectedCheck`.
  * [ ] Обновить пайплайн для включения результатов UI-тестов в Allure Report.
  * [ ] Настроить запуск UI-тестов при создании **`pull_request` в `main`**.
* [ ] **Финализация:**
  * [ ] Выполнить слияние ветки `feature/6-espresso-initial` в `develop`.

## Этап 7: Рефакторинг UI-слоя (19.10 - 21.10)

**Цель:** Улучшить код UI-компонентов (`Fragments`, `Activities`), который теперь покрыт Espresso-тестами.

* [ ] **Ветка:** `feature/7-ui-refactoring` (создается из `develop`)
* [ ] **Задачи по коду:**
  * [ ] Провести рефакторинг `LoginFragment`, `ProductCatalogFragment` и связанных `Activities`.
  * [ ] Убедиться, что все существующие тесты (Unit, Integration, Espresso) проходят после рефакторинга.
* [ ] **Задачи по CI/CD:**
  * [ ] Убедиться, что пайплайн успешно проходит все этапы (сборка, анализ, все виды тестов).
* [ ] **Финализация:**
  * [ ] Выполнить слияние ветки `feature/7-ui-refactoring` в `develop`.

## Этап 8: Улучшение читаемости тестов с Kakao (22.10 - 27.10)

**Цель:** Улучшить поддерживаемость тестов с помощью DSL Kakao и паттерна Page Object.

* [ ] **Ветка:** `feature/8-kakao` (создается из `develop`)
* [ ] **Задачи по коду:**
  * [ ] Провести рефакторинг существующих Espresso-тестов на Kakao.
  * [ ] Реализовать Page Objects для экранов Login и Catalog.
  * [ ] Написать новые тесты для флоу "Добавление товара в корзину".
* [ ] **Задачи по CI/CD:**
  * [ ] Убедиться, что тесты на Kakao корректно запускаются в существующих пайплайнах GitHub Actions и GitLab CI.
* [ ] **Финализация:**
  * [ ] Выполнить слияние ветки `feature/8-kakao` в `develop`.

## Этап 9: Современный подход с Kaspresso (28.10 - 06.11)

**Цель:** Освоить фреймворк Kaspresso, покрыть сложные сценарии, интегрироваться с облачными фермами.

* [ ] **Ветка:** `feature/9-kaspresso` (создается из `develop`)
* [ ] **Задачи по коду:**
  * [ ] Провести миграцию тестов с Kakao на Kaspresso.
  * [ ] Реализовать сложные тесты с использованием API Kaspresso:
    * [ ] Тест, который предоставляет/запрещает разрешения (permissions).
    * [ ] Тест, который выполняет ADB-команды (например, включение/выключение Wi-Fi).
  * [ ] Расширить покрытие Unit-тестами для ViewModel и репозиториев.
  * [ ] Достичь 100% покрытия тест-плана UI-тестами и высокого покрытия кода Unit-тестами.
* [ ] **Задачи по CI/CD:**
  * [ ] Интегрировать пайплайн с облачными фермами устройств (**BrowserStack**, **Firebase Test Lab**) для запуска тестов на реальных устройствах.
  * [ ] Убедиться, что отчеты Allure корректно генерируются после прогонов на облачных фермах.
* [ ] **Финализация:**
  * [ ] Выполнить слияние ветки `feature/9-kaspresso` в `develop`, а затем в `main` для релиза.

## Этап 10: Рефакторинг и финализация (07.11 - 17.11)

**Цель:** Привести кодовую базу приложения в идеальное состояние, продемонстрировав практику безопасного рефакторинга под защитой тестов, и оптимизировать CI.

* [ ] **Ветка:** `feature/10-kotlin-conversion` (создается из `develop`)
* [ ] **Задачи по коду (рефакторинг под защитой тестов):**
  * [ ] **Шаг 1:** Полностью конвертировать исходный код приложения из Java в Kotlin.
  * [ ] **Шаг 2:** Перевести все Gradle-скрипты (`build.gradle`) на Kotlin DSL (`build.gradle.kts`).
  * [ ] **Шаг 3:** Заменить использование `findViewById` на `ViewBinding`.
* [ ] **Задачи по CI/CD:**
  * [ ] Заменить инструменты анализа Java (`Checkstyle`, `PMD`) на инструменты для Kotlin (`Detekt`, `Ktlint`).
  * [ ] Настроить **кэширование Gradle-зависимостей** для ускорения сборок.
  * [ ] Настроить **распараллеливание тестов (sharding)** с помощью **Marathon** для сокращения времени выполнения.
  * [ ] Настроить публикацию в **Google Play Market** при слиянии в `main`:
    * [ ] Интегрировать **Gradle Play Publisher**.
    * [ ] (Альтернатива) Настроить **Fastlane** для автоматизации релиза.
  * [ ] Настроить автоматическое создание и отправку **Git-тегов** при релизе в `main`.
  * [ ] Настроить Quality Gate (QG) для статического анализа: пайплайн должен падать при наличии критических ошибок.
  * [ ] Настроить собственный self-hosted runner (на Beget) для ускорения и удешевления сборок.
* [ ] **Финализация:**
  * [ ] Выполнить слияние ветки `feature/10-kotlin-conversion` в `develop`, а затем в `main`.
  * [ ] Обновить `README.md` проекта, описав финальный стек, структуру и все проделанные шаги.
