# Детальный План Работы над проектом "kotlin-android-test-demo"

Этот документ является детализацией общего стратегического плана и описывает конкретные задачи для проекта `kotlin-android-test-demo`. Цель проекта — создать исчерпывающее портфолио, демонстрирующее эволюцию подходов к UI-тестированию в Android.

## Структура веток

Проект развивается поэтапно, следуя GitFlow-подобной стратегии. Каждый этап представлен в отдельной feature-ветке.

| Ветка | Описание | Ключевые технологии |
| :--- | :--- | :--- |
| `feature/*` | Ветки для разработки нового функционала (например, `feature/1-infrastructure-setup`). Создаются из `develop`. | - |
| `develop` | **Ветка для интеграции:** Основная ветка разработки, куда сливаются `feature`-ветки. | - |
| `main` | **Релизная ветка:** Содержит стабильный код, готовый к публикации. Слияние в `main` инициирует релизный процесс. | - |
| `feature/1-infrastructure-setup` | **Подготовка инфраструктуры:** Настройка CI/CD, статического анализа Java-кода и сбора покрытия. | `GitHub Actions`, `GitLab CI`, `Docker`, `Checkstyle`, `PMD`, `JaCoCo` |
| `feature/2-unit-tests` | **Модульное тестирование:** Написание Unit-тестов для бизнес-логики и интеграция с Allure TestOps. | `JUnit5`, `Allure TestOps` |
| `feature/3-logic-refactoring` | **Рефакторинг бизнес-логики:** Исправление проблем, найденных статическим анализом, под защитой Unit-тестов. | `Java`, `Checkstyle`, `PMD` |
| `feature/4-integration-tests` | **Интеграционное тестирование:** Написание тестов для проверки взаимодействия компонентов (например, слой БД). | `JUnit5`, `Room` |
| `feature/5-integration-refactoring` | **Рефакторинг слоя данных:** Исправление кода, связанного с базой данных, под защитой интеграционных тестов. | `Java`, `Room` |
| `feature/6-espresso-initial` | **Базовый уровень UI-тестов:** Реализация первых UI-тестов с использованием **Espresso**. | `Espresso`, `JUnit4` |
| `feature/7-ui-refactoring` | **Рефакторинг UI-слоя:** Исправление кода UI-компонентов под защитой Espresso-тестов. | `Java`, `Espresso` |
| `feature/8-kakao` | **Улучшение читаемости:** Тесты переписаны с использованием DSL-обертки **Kakao**, внедрен паттерн Page Object. | `Kakao`, `Page Object` |
| `feature/9-kaspresso` | **Стабильность и мощь:** Тесты мигрированы на фреймворк **Kaspresso** для повышения стабильности и работы со сложными сценариями. | `Kaspresso`, `BrowserStack` |
| `feature/10-kotlin-conversion` | **Рефакторинг:** Проведен масштабный рефакторинг исходного кода приложения под защитой Kaspresso-тестов. | `Kotlin`, `ViewBinding`, `Gradle KTS` |

---

## Этап 1: Настройка инфраструктуры и CI/CD (11.09 - 20.09)

**Цель:** Создать надежный фундамент для разработки и тестирования. Настроить базовый CI/CD пайплайн и интегрировать статический анализ для **Java-кода**.

*   [x] **Ветка:** `feature/1-infrastructure-setup`
*   [x] **Задачи по коду:**
    *   [x] Разработать тест-план (`TESTING_STRATEGY.md`).
*   [x] **Задачи по CI/CD (GitHub Actions):**
    *   [x] Создать workflow `.github/workflows/ci.yml` с базовой логикой запуска (`push`).
    *   [x] Настроить сборку debug APK.
    *   [x] Интегрировать статические анализаторы: **Checkstyle**, **PMD**, **Android Lint**.
    *   [x] Настроить публикацию отчетов на **GitHub Pages**.
    *   [x] Оптимизировать пайплайн: распараллелить задачи, настроить кэширование и очистку кэша.
    *   [x] Настроить ручной запуск (`workflow_dispatch`) и управление временем хранения артефактов.
*   [ ] **Задачи по CI/CD (GitLab CI):**
    *   **Развертывание GitLab:**
        *   [x] Зарегистрировать доменное имя и привязать его к IP-адресу сервера.
        *   [x] Установить GitLab (Community Edition) на арендованном сервере с помощью Docker.
        *   [x] Выполнить первый вход и сменить пароль администратора.
        *   [x] Настроить локальный SSH-клиент для работы с нестандартным портом.
        *   [x] Создать пользователей и проект в GitLab.
        *   [x] Настроить локальный репозиторий для одновременной работы с GitHub и GitLab.
    *   **Подготовка образа:**
        *   [x] Создать `Dockerfile` для сборки Android-проекта, включающий нужную версию JDK и Android SDK.
        *   [x] Настроить `Container Registry` в GitLab для хранения Docker-образа.
    *   **Настройка Runner'а:**
        *   [x] Установить и зарегистрировать GitLab Runner на арендованном сервере (Beget).
        *   [x] Настроить раннер для использования Docker-executor'а.
    *   **Настройка `.gitlab-ci.yml`:**
        *   [ ] Создать файл `.gitlab-ci.yml` и определить `stages` (например, `analyze`, `test`, `build`, `report`).
        *   [ ] Настроить использование созданного Docker-образа по умолчанию для всех `jobs`.
        *   [ ] Настроить кэширование зависимостей Gradle с помощью `cache` keyword.
    *   **Интеграция статического анализа (параллельно):**
        *   [ ] Создать job `checkstyle` в `analyze` stage, которая запускает `./gradlew app:checkstyleDebug` и сохраняет отчет как артефакт (`artifacts:paths`).
        *   [ ] Создать job `pmd` в `analyze` stage, которая запускает `./gradlew app:pmdDebug` и сохраняет отчет.
        *   [ ] Создать job `lint` в `analyze` stage, которая запускает `./gradlew app:lintDebug` и сохраняет отчет.
    *   **Интеграция тестов:**
        *   [ ] Создать job `unit-test` в `test` stage, которая зависит от `analyze` stage (`needs`) и запускает `./gradlew testDebugUnitTest`.
    *   **Сборка приложения:**
        *   [ ] Создать job `build` в `build` stage, которая зависит от `test` stage.
        *   [ ] Настроить `rules` для сборки `debug` или `release` APK в зависимости от ветки (`CI_COMMIT_BRANCH`).
    *   **Публикация отчетов (GitLab Pages):**
        *   [ ] Создать специальную job `pages` в `report` stage.
        *   [ ] Настроить `needs` для загрузки артефактов (отчетов) из всех предыдущих `jobs`.
        *   [ ] Адаптировать скрипт для генерации `index.html` и копирования отчетов в директорию `public`.
        *   [ ] Настроить `artifacts:paths` для публикации директории `public` на GitLab Pages.
*   [ ] **Финализация:**
    *   [ ] Выполнить слияние ветки `feature/1-infrastructure-setup` в `develop`.

## Этап 2: Модульное тестирование (Unit Tests) и интеграция с Allure (21.09 - 28.09)

**Цель:** Написать первые модульные тесты для бизнес-логики, настроить сбор покрытия и интеграцию с Allure TestOps.

*   [ ] **Ветка:** `feature/2-unit-tests` (создается из `develop`)
*   [ ] **Задачи по коду:**
    *   [ ] Написать Unit-тесты для бизнес-логики и ViewModel, используя **JUnit 5**, **MockK** и **Truth**.
*   [ ] **Задачи по CI/CD (GitHub Actions):**
    *   [ ] Настроить job `unit-test` для запуска Unit-тестов (`./gradlew test`).
    *   [ ] Обновить Quality Gate: пайплайн должен падать при провале тестов.
    *   [ ] Настроить **JaCoCo** для сбора и генерации отчетов о покрытии кода тестами.
    *   [ ] Настроить Quality Gate (QG) для покрытия: пайплайн должен падать, если покрытие ниже установленного порога (например, 50%).
*   [ ] **Задачи по интеграции с Allure:**
    *   [ ] Развернуть стенд Allure TestOps (локально через Docker или использовать облачную версию).
    *   [ ] Добавить плагин Allure в Gradle.
    *   [ ] Настроить пайплайн для отправки результатов тестов, статического анализа и отчетов о покрытии в Allure TestOps/Allure Report.
*   [ ] **Финализация:**
    *   [ ] Выполнить слияние ветки `feature/2-unit-tests` в `develop`.

## Этап 3: Рефакторинг бизнес-логики (29.09 - 02.10)

**Цель:** Исправить проблемы в Java-коде, обнаруженные статическими анализаторами (Checkstyle, PMD). Рефакторинг проводится безопасно, так как код покрыт Unit-тестами.

*   [ ] **Ветка:** `feature/3-logic-refactoring` (создается из `develop`)
*   [ ] **Задачи по коду:**
    *   [ ] Проанализировать отчеты статического анализа.
    *   [ ] Провести рефакторинг классов с бизнес-логикой (`SingletonClass`, `ViewModels` и т.д.).
    *   [ ] Убедиться, что все Unit-тесты по-прежнему проходят после рефакторинга.
*   [ ] **Задачи по CI/CD:**
    *   [ ] Убедиться, что после рефакторинга пайплайн проходит проверки статического анализа (Checkstyle, PMD).
*   [ ] **Финализация:**
    *   [ ] Выполнить слияние ветки `feature/3-logic-refactoring` в `develop`.

## Этап 4: Интеграционное тестирование (03.10 - 09.10)

**Цель:** Проверить корректность взаимодействия между компонентами, в первую очередь — работу с базой данных (Room).

*   [ ] **Ветка:** `feature/4-integration-tests` (создается из `develop`)
*   [ ] **Задачи по коду:**
    *   [ ] Написать интеграционные тесты для `AppDao` с использованием in-memory базы данных на **JUnit 5**.
    *   [ ] Проверить операции вставки, чтения, удаления и сортировки.
*   [ ] **Задачи по CI/CD:**
    *   [ ] Добавить в пайплайн job для запуска интеграционных тестов.
    *   [ ] Убедиться, что результаты тестов и обновленное покрытие кода отправляются в Allure.
    *   [ ] Настроить логику запуска пайплайна для **`pull_request` в `develop`** (добавить запуск интеграционных тестов).
*   [ ] **Финализация:**
    *   [ ] Выполнить слияние ветки `feature/4-integration-tests` в `develop`.

## Этап 5: Рефакторинг слоя данных (10.10 - 12.10)

**Цель:** Улучшить код, связанный с базой данных и репозиториями, под защитой написанных интеграционных тестов.

*   [ ] **Ветка:** `feature/5-integration-refactoring` (создается из `develop`)
*   [ ] **Задачи по коду:**
    *   [ ] Провести рефакторинг `AppDao`, `AppDatabase`, `DatabaseRepository`.
    *   [ ] Убедиться, что все интеграционные тесты проходят после рефакторинга.
*   [ ] **Финализация:**
    *   [ ] Выполнить слияние ветки `feature/5-integration-refactoring` в `develop`.

## Этап 6: UI-тестирование (Espresso) (13.10 - 16.10)

**Цель:** Написать первые UI-тесты и интегрировать их результаты в существующую CI/CD и Allure-инфраструктуру.

*   [ ] **Ветка:** `feature/6-espresso-initial` (создается из `develop`)
*   [ ] **Задачи по коду:**
    *   [ ] Написать UI-тесты на Espresso (на **JUnit 4**) для сценариев "Логин" и "Просмотр каталога".
*   [ ] **Задачи по CI/CD (GitHub Actions):**
    *   [ ] Настроить job `ui-test`, который зависит от `build`:
        *   [ ] Использовать `reactivecircus/android-emulator-runner` для запуска эмулятора.
        *   [ ] Запустить `./gradlew connectedCheck`.
    *   [ ] Обновить пайплайн для отправки результатов UI-тестов в Allure.
    *   [ ] Настроить логику запуска пайплайна для **`pull_request` в `main`** (добавить запуск UI-тестов и сборку release-версии).
*   [ ] **Финализация:**
    *   [ ] Выполнить слияние ветки `feature/6-espresso-initial` в `develop`.

## Этап 7: Рефакторинг UI-слоя (17.10 - 19.10)

**Цель:** Улучшить код UI-компонентов (`Fragments`, `Activities`), который теперь покрыт Espresso-тестами.

*   [ ] **Ветка:** `feature/7-ui-refactoring` (создается из `develop`)
*   [ ] **Задачи по коду:**
    *   [ ] Провести рефакторинг `LoginFragment`, `ProductCatalogFragment` и связанных `Activities`.
    *   [ ] Убедиться, что все существующие тесты (Unit, Integration, Espresso) проходят после рефакторинга.
*   [ ] **Задачи по CI/CD:**
    *   [ ] Убедиться, что пайплайн успешно проходит все этапы (сборка, анализ, все виды тестов).
*   [ ] **Финализация:**
    *   [ ] Выполнить слияние ветки `feature/7-ui-refactoring` в `develop`.

## Этап 8: Улучшение читаемости тестов с Kakao (20.10 - 26.10)

**Цель:** Улучшить поддерживаемость тестов с помощью DSL Kakao и паттерна Page Object.

*   [ ] **Ветка:** `feature/8-kakao` (создается из `develop`)
*   [ ] **Задачи по коду:**
    *   [ ] Провести рефакторинг существующих Espresso-тестов на Kakao.
    *   [ ] Реализовать Page Objects для экранов Login и Catalog.
    *   [ ] Написать новые тесты для флоу "Добавление товара в корзину".
*   [ ] **Задачи по CI/CD:**
    *   [ ] Убедиться, что тесты на Kakao корректно запускаются в существующих пайплайнах GitHub Actions и GitLab CI.
*   [ ] **Финализация:**
    *   [ ] Выполнить слияние ветки `feature/8-kakao` в `develop`.

## Этап 9: Современный подход с Kaspresso (27.10 - 07.11)

**Цель:** Освоить фреймворк Kaspresso, покрыть сложные сценарии, интегрироваться с облачными фермами.

*   [ ] **Ветка:** `feature/9-kaspresso` (создается из `develop`)
*   [ ] **Задачи по коду:**
    *   [ ] Провести миграцию тестов с Kakao на Kaspresso.
    *   [ ] Реализовать сложные тесты с использованием API Kaspresso:
        *   [ ] Тест, который предоставляет/запрещает разрешения (permissions).
        *   [ ] Тест, который выполняет ADB-команды (например, включение/выключение Wi-Fi).
    *   [ ] Расширить покрытие Unit-тестами для ViewModel и репозиториев.
    *   [ ] Достичь 100% покрытия тест-плана UI-тестами и высокого покрытия кода Unit-тестами.
*   [ ] **Задачи по CI/CD:**
    *   [ ] Интегрировать пайплайн с облачными фермами устройств (**BrowserStack**, **Firebase Test Lab**) для запуска тестов на реальных устройствах.
    *   [ ] Настроить интеграцию с **Allure TestOps**:
    *   [ ] Улучшить интеграцию с **Allure TestOps**:
        *   [ ] Пайплайн должен отправлять результаты в TestOps.
        *   [ ] Настроить запуск тестов из интерфейса TestOps.
*   [ ] **Финализация:**
    *   [ ] Выполнить слияние ветки `feature/9-kaspresso` в `develop`, а затем в `main` для релиза.

## Этап 10: Рефакторинг и финализация (08.11 - 18.11)

**Цель:** Привести кодовую базу приложения в идеальное состояние, продемонстрировав практику безопасного рефакторинга под защитой тестов, и оптимизировать CI.

*   [ ] **Ветка:** `feature/10-kotlin-conversion` (создается из `develop`)
*   [ ] **Задачи по коду (рефакторинг под защитой тестов):**
    *   [ ] **Шаг 1:** Полностью конвертировать исходный код приложения из Java в Kotlin.
    *   [ ] **Шаг 2:** Перевести все Gradle-скрипты (`build.gradle`) на Kotlin DSL (`build.gradle.kts`).
    *   [ ] **Шаг 3:** Заменить использование `findViewById` на `ViewBinding`.
*   [ ] **Задачи по CI/CD:**
    *   [ ] Заменить инструменты анализа Java (`Checkstyle`, `PMD`) на инструменты для Kotlin (`Detekt`, `Ktlint`).
    *   [ ] Настроить **кэширование Gradle-зависимостей** для ускорения сборок.
    *   [ ] Настроить **распараллеливание тестов (sharding)** с помощью **Marathon** для сокращения времени выполнения.
    *   [ ] Настроить публикацию в **Google Play Market** при слиянии в `main`:
        *   [ ] Интегрировать **Gradle Play Publisher**.
        *   [ ] (Альтернатива) Настроить **Fastlane** для автоматизации релиза.
    *   [ ] Настроить автоматическое создание и отправку **Git-тегов** при релизе в `main`.
    *   [ ] Настроить Quality Gate (QG) для статического анализа: пайплайн должен падать при наличии критических ошибок.
    *   [ ] Настроить собственный self-hosted runner (на Beget) для ускорения и удешевления сборок.
*   [ ] **Финализация:**
    *   [ ] Выполнить слияние ветки `feature/10-kotlin-conversion` в `develop`, а затем в `main`.
    *   [ ] Обновить `README.md` проекта, описав финальный стек, структуру и все проделанные шаги.
